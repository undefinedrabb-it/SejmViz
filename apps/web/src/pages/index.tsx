import Head from 'next/head';
import React, { useEffect } from 'react';

type ClubK =
  | 'KO'
  | 'Konfederacja'
  | 'KP'
  | 'Kukiz15'
  | 'Lewica'
  | 'niez.'
  | 'PiS'
  | 'Polska2050'
  | 'Porozumienie'
  | 'PPS'
  | 'PS';

type ClubT = {
  email: string;
  fax: string;
  id: ClubK;
  membersCount: number;
  name: string;
  phone: string;
};

type MPT = {
  id: number;
  firstLastName: string;
  lastFirstName: string;
  firstName: string;
  secondName: string;
  lastName: string;
  email: string;
  active: boolean;
  inactiveCause: string;
  waiverDesc: string;
  discritNum: number;
  districtName: string;
  voivodeship: string;
  club: ClubT['id'];
};

const clubsC = {
  Lewica: 'bg-[#851a64]',
  KP: 'bg-[#1bb100]',
  PPS: 'bg-[#d62d32]',
  KO: 'bg-[#ff6e28]',
  'niez.': 'bg-[#bbbbbb]',
  Polska2050: 'bg-[#ffaf05]',
  Kukiz15: 'bg-[#000000]',
  Porozumienie: 'bg-[#733c4d]',
  PS: 'bg-[#8bc0ea]',
  PiS: 'bg-[#000dc0]',
  Konfederacja: 'bg-[#633e1c]',
} as const;
const clubS: readonly string[] = Object.keys(clubsC);

type MPEnhanedT = Pick<MPT, 'id' | 'club'> & { color: string };
type ClubsEnhanedT = Pick<ClubT, 'id' | 'name'> & { color: string };

export async function getStaticProps() {
  //TODO error handling

  const [resMPs, resClubs] = await Promise.all([
    fetch('http://api.sejm.gov.pl/sejm/term9/MP'),
    fetch('http://api.sejm.gov.pl/sejm/term9/clubs'),
  ]);

  // eslint-disable-next-line @typescript-eslint/no-unsafe-assignment -- h
  const [mps, clubs]: [MPT[], ClubT[]] = await Promise.all([
    resMPs.json(),
    resClubs.json(),
  ]);

  mps.sort((a, b) => clubS.indexOf(a.club) - clubS.indexOf(b.club));
  clubs.sort((a, b) => clubS.indexOf(a.id) - clubS.indexOf(b.id));

  const [mpsE, clubsE]: [MPEnhanedT[], ClubsEnhanedT[]] = [
    mps
      .filter(m => m.active)
      .map(({ id, club }) => ({
        id,
        club,
        color: clubsC[club],
      })),
    clubs.map(({ id, name }) => ({
      id,
      name,
      color: clubsC[id],
    })),
  ];

  return {
    props: {
      mpsE,
      clubsE,
    },
  };
}
type Props = Awaited<ReturnType<typeof getStaticProps>>['props'];

const bg = (color?: string) => (color ? color : 'bg-white');
const op = (isHidden?: boolean | null) => (isHidden ? 'opacity-10' : '');

const Circle = ({
  color,
  isHidden,
}: {
  color?: string;
  isHidden?: boolean | null;
}) => (
  <div
    className={`h-10 w-10 min-w-fit rounded-full border-2 border-solid 
    border-white ${bg(color)} ${op(isHidden)}`}
  >
    {' '}
  </div>
);

const flag = false;
const thoughts = [
  { id: 'lib', color: 'bg-[#ffe800]' },
  { id: 'liber', color: undefined },
  { id: 'soc', color: 'bg-[#d6d421]' },
  { id: 'fem', color: undefined },
  { id: 'queer', color: undefined },
  { id: 'anarch', color: undefined },
  { id: 'fash', color: undefined },
  { id: 'naz', color: undefined },
] as const;

const Home = ({ mpsE, clubsE }: Props) => {
  const [focused, setF] = React.useState<ClubK | null>(null);

  const [mps, setMps] = React.useState(
    mpsE.map(mp => ({ ...mp, isHidden: false })),
  );
  const [clubs, setClubs] = React.useState(
    clubsE.map(c => ({ ...c, isHidden: false })),
  );

  useEffect(() => {
    const t = setTimeout(() => {
      setMps(p =>
        p.map(pmp =>
          !focused || pmp.club === focused
            ? { ...pmp, isHidden: false }
            : { ...pmp, isHidden: true },
        ),
      );
      setClubs(p =>
        p.map(pc =>
          !focused || pc.id === focused
            ? { ...pc, isHidden: false }
            : { ...pc, isHidden: true },
        ),
      );
    }, 100);
    return () => clearTimeout(t);
  }, [focused, setMps]);

  const setOrToggleIfSame = (id: ClubK) => () =>
    setF(id === focused ? null : id);

  return (
    <>
      <Head>
        <title>Create T3 App</title>
        <meta name="description" content="Generated by create-t3-app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main
        className=" h-screen w-screen overflow-hidden bg-gray-800"
        onFocus={() => setF(null)}
        onBlur={() => setF(null)}
      >
        <div className="flex-rows flex flex-wrap justify-around p-4">
          <div className="flex flex-col gap-2">
            {clubs.map(({ id, color, isHidden }, i) => (
              <button
                key={`${id}-${i}`}
                className="flex-rows flex items-center p-1"
                onClick={setOrToggleIfSame(id)}
              >
                <Circle color={color} isHidden={isHidden} />
                <div className="ml-2 text-lg text-white">{id}</div>
              </button>
            ))}
          </div>
          <div className="grid w-3/4 grid-cols-23 gap-1">
            {mps.map(({ id, color, club, isHidden }, i) => (
              <button key={`${id}-${i}`} onClick={setOrToggleIfSame(club)}>
                <Circle color={color} isHidden={isHidden} />
              </button>
            ))}
          </div>
          {flag && (
            <div className="flex flex-col">
              {thoughts.map(({ id, color }, i) => (
                <div
                  className="m-2 flex flex-row items-center "
                  key={`${id}-${i}`}
                >
                  <Circle color={color} />
                  <div className="ml-2 text-lg text-white">{id}</div>
                </div>
              ))}
            </div>
          )}
        </div>
      </main>
    </>
  );
};

export default Home;
